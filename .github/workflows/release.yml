name: Build and Release

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'package.json'
  workflow_dispatch:

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version-changed: ${{ steps.check.outputs.changed }}
    steps:
      - name: ðŸš€ Job Started
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” CHECK VERSION JOB"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â° Started at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ“¦ Repository: ${{ github.repository }}"
          echo "ðŸ”€ Branch: ${{ github.ref_name }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get current version
        id: version
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ GETTING CURRENT VERSION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Current version: $VERSION"
          echo "ðŸ“„ Package.json path: $(pwd)/package.json"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check if version changed
        id: check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”„ CHECKING VERSION CHANGE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "ðŸ“Œ Current version: $CURRENT_VERSION"
          
          # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ³Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°
          PREVIOUS_VERSION=""
          echo "ðŸ” Checking previous commit..."
          if git show HEAD~1:package.json > /dev/null 2>&1; then
            PREVIOUS_VERSION=$(git show HEAD~1:package.json | node -p "JSON.parse(require('fs').readFileSync(0, 'utf-8')).version" 2>/dev/null || echo "")
            echo "ðŸ“Œ Previous commit version: ${PREVIOUS_VERSION:-'not found'}"
          else
            echo "âš ï¸ Cannot access previous commit"
          fi
          
          # Ð•ÑÐ»Ð¸ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð· Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ³Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ‚ÐµÐ³
          if [ -z "$PREVIOUS_VERSION" ]; then
            echo "ðŸ” Checking last git tag..."
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -n "$LAST_TAG" ]; then
              PREVIOUS_VERSION=$(echo "$LAST_TAG" | sed 's/^v//')
              echo "ðŸ“Œ Last tag version: $PREVIOUS_VERSION (from tag: $LAST_TAG)"
            else
              echo "â„¹ï¸ No tags found in repository"
            fi
          fi
          
          echo ""
          echo "ðŸ“Š Version Comparison:"
          echo "  Current:  $CURRENT_VERSION"
          echo "  Previous: ${PREVIOUS_VERSION:-'N/A (first release)'}"
          
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ] && [ -n "$PREVIOUS_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
            echo "ðŸš€ Release will be triggered"
          elif [ -z "$PREVIOUS_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… First release detected: $CURRENT_VERSION"
            echo "ðŸš€ Release will be triggered"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Version not changed: $CURRENT_VERSION"
            echo "â­ï¸ Release will be skipped"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  build-linux:
    needs: check-version
    if: needs.check-version.outputs.version-changed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      success: ${{ steps.set-output.outputs.success }}
    steps:
      - name: ðŸš€ Job Started
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ§ LINUX BUILD JOB"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â° Started at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ–¥ï¸  OS: $(uname -a)"
          echo "ðŸ“¦ Version: ${{ needs.check-version.outputs.version }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Environment Info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŒ ENVIRONMENT INFORMATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "Working directory: $(pwd)"
          echo "Available disk space:"
          df -h | grep -E '^/dev/'
          echo "Memory info:"
          free -h || echo "Memory info not available"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Clean install dependencies
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ INSTALLING DEPENDENCIES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ§¹ Step 1: Cleaning old dependencies..."
          rm -rf node_modules package-lock.json
          echo "âœ… Cleaned node_modules and package-lock.json"
          
          echo ""
          echo "ðŸ“¦ Step 2: Installing dependencies..."
          echo "Using: npm install --legacy-peer-deps"
          npm install --legacy-peer-deps 2>&1 | tail -20
          echo "âœ… Dependencies installed"
          
          echo ""
          echo "ðŸ”§ Step 3: Ensuring rollup native dependencies..."
          npm install @rollup/rollup-linux-x64-gnu --save-optional --force || echo "âš ï¸ Rollup native dependency install failed, but continuing..."
          
          echo ""
          echo "ðŸ§ª Step 4: Testing rollup..."
          ROLLUP_VERSION=$(npx rollup --version 2>&1 || echo "failed")
          if [ "$ROLLUP_VERSION" != "failed" ]; then
            echo "âœ… Rollup version: $ROLLUP_VERSION"
          else
            echo "âš ï¸ Rollup test failed"
          fi
          
          echo ""
          echo "ðŸ“Š Installed packages count:"
          npm list --depth=0 2>/dev/null | wc -l || echo "Cannot count packages"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Build application for Linux
        id: build
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”¨ BUILDING APPLICATION FOR LINUX"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â° Build started at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          set +e
          echo "ðŸ“‹ Running: npm run build:linux"
          npm run build:linux 2>&1 | tee build.log
          BUILD_EXIT_CODE=$?
          set -e
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š BUILD RESULT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Exit code: ${BUILD_EXIT_CODE}"
          echo "â° Build finished at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          
          if [ "${BUILD_EXIT_CODE}" -eq 0 ]; then
            echo "âœ… Linux build completed successfully"
          else
            echo "âŒ Linux build failed with exit code ${BUILD_EXIT_CODE}"
            echo ""
            echo "ðŸ“‹ Last 50 lines of build log:"
            tail -50 build.log || echo "Cannot read build log"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“‹ POST-BUILD DIAGNOSTICS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Checking build directory..."
          if [ -d "build" ]; then
            echo "âœ… Build directory exists"
            echo ""
            echo "ðŸ“‚ Contents of build directory:"
            ls -lah build/ || echo "Cannot list build directory"
            echo ""
            echo "ðŸ” Searching for AppImage files:"
            find build -name "*.AppImage" -o -name "*.appimage" 2>/dev/null | while read file; do
              echo "  âœ… Found: $file ($(du -h "$file" | cut -f1))"
            done || echo "  âŒ No AppImage found"
            echo ""
            echo "ðŸ“Š All files in build (first 20):"
            find build -type f 2>/dev/null | head -20 | while read file; do
              echo "  - $file"
            done || echo "  No files found"
            echo ""
            echo "ðŸ’¾ Total size of build directory:"
            du -sh build/ 2>/dev/null || echo "Cannot calculate size"
          else
            echo "âŒ Build directory does not exist"
            echo ""
            echo "Checking dist directory:"
            if [ -d "dist" ]; then
              echo "âœ… dist directory exists"
              ls -lah dist/ | head -10
            else
              echo "âŒ dist directory also does not exist"
            fi
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Set build output
        id: set-output
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” CHECKING BUILD ARTIFACTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Current directory: $(pwd)"
          echo "Build directory exists: $([ -d "build" ] && echo "yes" || echo "no")"
          
          if [ -d "build" ]; then
            echo ""
            echo "ðŸ“‚ Contents of build directory:"
            ls -lah build/ || echo "Cannot list build directory"
            echo ""
            echo "ðŸ“‚ Recursive structure (first 30 items):"
            find build -type f -o -type d 2>/dev/null | head -30 | while read item; do
              if [ -f "$item" ]; then
                echo "  ðŸ“„ $item ($(du -h "$item" 2>/dev/null | cut -f1))"
              else
                echo "  ðŸ“ $item/"
              fi
            done || echo "Cannot find files in build"
            echo ""
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ Ð¿Ð¾Ð´Ð¿Ð°Ð¿ÐºÐ¸)
            FILE_COUNT=$(find build -type f 2>/dev/null | wc -l)
            echo "ðŸ“Š Found $FILE_COUNT file(s) in build directory"
            
            # Ð˜Ñ‰ÐµÐ¼ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ Linux
            APPIMAGE=$(find build -name "*.AppImage" -o -name "*.appimage" 2>/dev/null | head -1)
            if [ -n "$APPIMAGE" ]; then
              APPIMAGE_SIZE=$(du -h "$APPIMAGE" | cut -f1)
              echo "âœ… Found AppImage: $APPIMAGE ($APPIMAGE_SIZE)"
            else
              echo "âš ï¸ No AppImage file found"
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð»ÑŽÐ±Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
            if [ "$FILE_COUNT" -gt 0 ]; then
              echo "success=true" >> $GITHUB_OUTPUT
              echo "âœ… Build artifacts found ($FILE_COUNT files)"
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "âŒ Build directory exists but is empty"
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Build directory does not exist"
            echo ""
            echo "Checking if dist exists: $([ -d "dist" ] && echo "yes" || echo "no")"
            if [ -d "dist" ]; then
              echo "dist directory contents:"
              ls -lah dist/ | head -10
            fi
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Upload build artifacts (Linux)
        if: steps.set-output.outputs.success == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¤ UPLOADING BUILD ARTIFACTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Artifact name: build-linux-${{ needs.check-version.outputs.version }}"
          echo "Files to upload:"
          find build -type f 2>/dev/null | head -20
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true

      - name: Upload build artifacts (Linux) - Action
        if: steps.set-output.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-linux-${{ needs.check-version.outputs.version }}
          path: |
            build/**/*
            !build/**/node_modules/**
          retention-days: 30
          if-no-files-found: error

  build-windows:
    needs: check-version
    if: needs.check-version.outputs.version-changed == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    continue-on-error: true
    outputs:
      success: ${{ steps.set-output.outputs.success }}
    steps:
      - name: ðŸš€ Job Started
        shell: pwsh
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸªŸ WINDOWS BUILD JOB"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "â° Started at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"
          Write-Host "ðŸ–¥ï¸  OS: $($env:OS)"
          Write-Host "ðŸ“¦ Version: ${{ needs.check-version.outputs.version }}"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Environment Info
        shell: pwsh
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸŒ ENVIRONMENT INFORMATION"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Node.js version: $(node --version)"
          Write-Host "npm version: $(npm --version)"
          Write-Host "Working directory: $(Get-Location)"
          Write-Host "Available disk space:"
          Get-PSDrive C | Format-Table -AutoSize
          Write-Host "Memory info:"
          Get-CimInstance Win32_OperatingSystem | Select-Object TotalVisibleMemorySize, FreePhysicalMemory | Format-List
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Clean install dependencies
        shell: pwsh
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸ“¦ INSTALLING DEPENDENCIES"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸ§¹ Step 1: Cleaning old dependencies..."
          Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
          Remove-Item -Force package-lock.json -ErrorAction SilentlyContinue
          Write-Host "âœ… Cleaned node_modules and package-lock.json"
          
          Write-Host ""
          Write-Host "ðŸ“¦ Step 2: Installing dependencies..."
          Write-Host "Using: npm install --legacy-peer-deps"
          npm install --legacy-peer-deps 2>&1 | Select-Object -Last 20
          Write-Host "âœ… Dependencies installed"
          
          Write-Host ""
          Write-Host "ðŸ§ª Step 3: Testing rollup..."
          $rollupVersion = npx rollup --version 2>&1
          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… Rollup version: $rollupVersion"
          } else {
            Write-Host "âš ï¸ Rollup test failed"
          }
          
          Write-Host ""
          Write-Host "ðŸ“Š Installed packages:"
          npm list --depth=0 2>&1 | Select-Object -First 30
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Build application for Windows
        id: build
        shell: pwsh
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸ”¨ BUILDING APPLICATION FOR WINDOWS"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          $startTime = Get-Date
          Write-Host "â° Build started at: $($startTime.ToString('yyyy-MM-dd HH:mm:ss UTC'))"
          Write-Host ""
          
          $ErrorActionPreference = "Continue"
          Write-Host "ðŸ“‹ Running: npm run build:win"
          npm run build:win 2>&1 | Tee-Object -FilePath build.log
          $buildExitCode = $LASTEXITCODE
          
          $endTime = Get-Date
          $duration = $endTime - $startTime
          
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸ“Š BUILD RESULT"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Exit code: $buildExitCode"
          Write-Host "â° Build finished at: $($endTime.ToString('yyyy-MM-dd HH:mm:ss UTC'))"
          Write-Host "â±ï¸  Duration: $($duration.ToString('mm\:ss'))"
          
          if ($buildExitCode -eq 0) {
            Write-Host "âœ… Windows build completed successfully"
          } else {
            Write-Host "âŒ Windows build failed with exit code $buildExitCode"
            Write-Host ""
            Write-Host "ðŸ“‹ Last 50 lines of build log:"
            Get-Content build.log -Tail 50 -ErrorAction SilentlyContinue
          }
          
          Write-Host ""
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸ“‹ POST-BUILD DIAGNOSTICS"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Checking build directory..."
          if (Test-Path "build" -PathType Container) {
            Write-Host "âœ… Build directory exists"
            Write-Host ""
            Write-Host "ðŸ“‚ Contents of build directory:"
            Get-ChildItem -Path "build" | Format-Table -AutoSize
            Write-Host ""
            Write-Host "ðŸ” Searching for .exe files:"
            $exeFiles = Get-ChildItem -Path "build" -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue
            if ($exeFiles.Count -gt 0) {
              $exeFiles | ForEach-Object { 
                $size = [math]::Round($_.Length / 1MB, 2)
                Write-Host "  âœ… Found: $($_.FullName) ($size MB)"
              }
            } else {
              Write-Host "  âŒ No .exe files found"
            }
            Write-Host ""
            Write-Host "ðŸ“Š All files in build (first 20):"
            Get-ChildItem -Path "build" -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 20 | ForEach-Object {
              $size = [math]::Round($_.Length / 1MB, 2)
              Write-Host "  - $($_.FullName) ($size MB)"
            }
            Write-Host ""
            $totalSize = (Get-ChildItem -Path "build" -Recurse -File -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum
            $totalSizeMB = [math]::Round($totalSize / 1MB, 2)
            Write-Host "ðŸ’¾ Total size of build directory: $totalSizeMB MB"
          } else {
            Write-Host "âŒ Build directory does not exist"
            Write-Host ""
            Write-Host "Checking dist directory:"
            if (Test-Path "dist" -PathType Container) {
              Write-Host "âœ… dist directory exists"
              Get-ChildItem -Path "dist" | Select-Object -First 10 | Format-Table -AutoSize
            } else {
              Write-Host "âŒ dist directory also does not exist"
            }
          }
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Set build output
        id: set-output
        if: always()
        shell: pwsh
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸ” CHECKING BUILD ARTIFACTS"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Build directory exists: $(Test-Path "build" -PathType Container)"
          
          if (Test-Path "build" -PathType Container) {
            Write-Host ""
            Write-Host "ðŸ“‚ Contents of build directory:"
            Get-ChildItem -Path "build" | Format-Table -AutoSize
            Write-Host ""
            Write-Host "ðŸ“‚ Recursive structure (first 30 items):"
            Get-ChildItem -Path "build" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 30 | ForEach-Object {
              if ($_.PSIsContainer) {
                Write-Host "  ðŸ“ $($_.FullName)\"
              } else {
                $size = [math]::Round($_.Length / 1MB, 2)
                Write-Host "  ðŸ“„ $($_.FullName) ($size MB)"
              }
            }
            Write-Host ""
            
            # Ð˜Ñ‰ÐµÐ¼ Ð²ÑÐµ Ñ„Ð°Ð¹Ð»Ñ‹
            $files = Get-ChildItem -Path "build" -Recurse -File -ErrorAction SilentlyContinue
            $fileCount = $files.Count
            Write-Host "ðŸ“Š Found $fileCount file(s) in build directory"
            
            # Ð˜Ñ‰ÐµÐ¼ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ Windows
            $exeFiles = Get-ChildItem -Path "build" -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue
            if ($exeFiles.Count -gt 0) {
              Write-Host "âœ… Found $($exeFiles.Count) .exe file(s):"
              $exeFiles | ForEach-Object { 
                $size = [math]::Round($_.Length / 1MB, 2)
                Write-Host "  - $($_.FullName) ($size MB)"
              }
            } else {
              Write-Host "âš ï¸ No .exe files found"
            }
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð»ÑŽÐ±Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
            if ($fileCount -gt 0) {
              "success=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              Write-Host "âœ… Build artifacts found ($fileCount files)"
            } else {
              "success=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              Write-Host "âŒ Build directory exists but is empty"
            }
          } else {
            "success=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            Write-Host "âŒ Build directory does not exist"
            Write-Host ""
            Write-Host "Checking if dist exists: $(Test-Path "dist" -PathType Container)"
            if (Test-Path "dist" -PathType Container) {
              Write-Host "dist directory contents:"
              Get-ChildItem -Path "dist" | Select-Object -First 10 | Format-Table -AutoSize
            }
          }
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Upload build artifacts (Windows)
        if: steps.set-output.outputs.success == 'true'
        shell: pwsh
        run: |
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ðŸ“¤ UPLOADING BUILD ARTIFACTS"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "Artifact name: build-win-${{ needs.check-version.outputs.version }}"
          Write-Host "Files to upload:"
          Get-ChildItem -Path "build" -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 20 | ForEach-Object {
            Write-Host "  - $($_.FullName)"
          }
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true

      - name: Upload build artifacts (Windows) - Action
        if: steps.set-output.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: build-win-${{ needs.check-version.outputs.version }}
          path: |
            build/**/*
            !build/**/node_modules/**
          retention-days: 30
          if-no-files-found: error

  create-release:
    needs: [check-version, build-linux, build-windows]
    if: |
      (needs.check-version.outputs.version-changed == 'true' || github.event_name == 'workflow_dispatch') &&
      (needs.build-linux.outputs.success == 'true' || needs.build-windows.outputs.success == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    continue-on-error: true
    
    steps:
      - name: ðŸš€ Job Started
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸš€ CREATE RELEASE JOB"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â° Started at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ“¦ Version: ${{ needs.check-version.outputs.version }}"
          echo "ðŸ§ Linux build success: ${{ needs.build-linux.outputs.success }}"
          echo "ðŸªŸ Windows build success: ${{ needs.build-windows.outputs.success }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ changelog

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ INSTALLING DEPENDENCIES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          npm ci
          echo "âœ… Dependencies installed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Generate release notes
        id: release-notes
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“ GENERATING RELEASE NOTES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if node scripts/generate-release-notes.js > release-notes.md; then
            echo "âœ… Release notes generated successfully"
            echo "Preview (first 20 lines):"
            head -20 release-notes.md
          else
            echo "âš ï¸ Failed to generate release notes, using default"
            echo "# Release v${{ needs.check-version.outputs.version }}" > release-notes.md
          fi
          echo ""
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "âœ… Release notes saved to output"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Download all artifacts
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¥ DOWNLOADING ARTIFACTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Downloading artifacts with pattern: build-*"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true

      - name: Download all artifacts - Action
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: build-*
          merge-multiple: false
          fail-on-error: false

      - name: Organize artifacts by platform
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ ORGANIZING ARTIFACTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          mkdir -p release-files
          
          echo "ðŸ” Searching for artifacts..."
          echo "Available artifact directories:"
          find artifacts -type d -maxdepth 2 2>/dev/null | head -20 || echo "No artifacts directory found"
          echo ""
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð² Linux
          LINUX_DIR="artifacts/build-linux-${{ needs.check-version.outputs.version }}"
          if [ -d "$LINUX_DIR" ]; then
            echo "ðŸ“¦ Copying Linux artifacts from $LINUX_DIR..."
            LINUX_FILES=$(find "$LINUX_DIR" -type f | wc -l)
            find "$LINUX_DIR" -type f -exec cp {} release-files/ \;
            echo "âœ… Linux artifacts copied ($LINUX_FILES files)"
          else
            echo "âš ï¸ Linux artifacts not found at $LINUX_DIR"
          fi
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð² Windows
          WIN_DIR="artifacts/build-win-${{ needs.check-version.outputs.version }}"
          if [ -d "$WIN_DIR" ]; then
            echo "ðŸ“¦ Copying Windows artifacts from $WIN_DIR..."
            WIN_FILES=$(find "$WIN_DIR" -type f | wc -l)
            find "$WIN_DIR" -type f -exec cp {} release-files/ \;
            echo "âœ… Windows artifacts copied ($WIN_FILES files)"
          else
            echo "âš ï¸ Windows artifacts not found at $WIN_DIR"
          fi
          
          echo ""
          echo "ðŸ“‹ Release files:"
          ls -lh release-files/ 2>/dev/null || echo "No files found"
          echo ""
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÐµÑÑ‚ÑŒ Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ Ð¾Ð´Ð¸Ð½ Ñ„Ð°Ð¹Ð»
          FILE_COUNT=$(ls -1 release-files 2>/dev/null | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âŒ Error: No release files found!"
            echo ""
            echo "Available artifacts structure:"
            find artifacts -type f 2>/dev/null | head -10 || echo "No artifacts found"
            echo ""
            echo "Full artifacts tree:"
            tree artifacts 2>/dev/null || find artifacts -type d 2>/dev/null | head -20
            exit 1
          fi
          
          echo "âœ… Found $FILE_COUNT file(s) for release"
          echo "Total size:"
          du -sh release-files/ 2>/dev/null || echo "Cannot calculate size"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Create Release
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸš€ CREATING GITHUB RELEASE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Tag: v${{ needs.check-version.outputs.version }}"
          echo "Name: ðŸš€ Release v${{ needs.check-version.outputs.version }}"
          echo "Files to attach:"
          ls -lh release-files/ | head -10
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true

      - name: Create Release - Action
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          name: ðŸš€ Release v${{ needs.check-version.outputs.version }}
          body: ${{ steps.release-notes.outputs.notes }}
          files: |
            release-files/**/*
          draft: false
          prerelease: false
          generate_release_notes: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [check-version, build-linux, build-windows, create-release]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Build Status Summary
        run: |
          echo "## ðŸ“Š Build Status Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          
          LINUX_RESULT="${{ needs.build-linux.result }}"
          LINUX_SUCCESS="${{ needs.build-linux.outputs.success }}"
          if [ "$LINUX_RESULT" == "success" ] && [ "$LINUX_SUCCESS" == "true" ]; then
            echo "| Linux | âœ… Success | Build completed and artifacts uploaded |" >> $GITHUB_STEP_SUMMARY
          elif [ "$LINUX_RESULT" == "success" ]; then
            echo "| Linux | âš ï¸ Partial | Build completed but no artifacts found |" >> $GITHUB_STEP_SUMMARY
          elif [ "$LINUX_RESULT" == "failure" ]; then
            echo "| Linux | âŒ Failed | Build failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Linux | â­ï¸ Skipped | Not executed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          WIN_RESULT="${{ needs.build-windows.result }}"
          WIN_SUCCESS="${{ needs.build-windows.outputs.success }}"
          if [ "$WIN_RESULT" == "success" ] && [ "$WIN_SUCCESS" == "true" ]; then
            echo "| Windows | âœ… Success | Build completed and artifacts uploaded |" >> $GITHUB_STEP_SUMMARY
          elif [ "$WIN_RESULT" == "success" ]; then
            echo "| Windows | âš ï¸ Partial | Build completed but no artifacts found |" >> $GITHUB_STEP_SUMMARY
          elif [ "$WIN_RESULT" == "failure" ]; then
            echo "| Windows | âŒ Failed | Build failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Windows | â­ï¸ Skipped | Not executed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          RELEASE_RESULT="${{ needs.create-release.result }}"
          if [ "$RELEASE_RESULT" == "success" ]; then
            echo "| Release | âœ… Created | Release v${{ needs.check-version.outputs.version }} created successfully |" >> $GITHUB_STEP_SUMMARY
          elif [ "$RELEASE_RESULT" == "failure" ]; then
            echo "| Release | âŒ Failed | Failed to create release |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Release | â­ï¸ Skipped | Not executed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.check-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version Changed:** ${{ needs.check-version.outputs.version-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
